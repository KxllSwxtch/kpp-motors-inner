import { useEffect, useState } from 'react'
import { useParams } from 'react-router-dom'
import axios from 'axios'
import Slider from 'react-slick'
import 'slick-carousel/slick/slick.css'
import 'slick-carousel/slick/slick-theme.css'
import { FaWhatsapp, FaInstagram, FaTiktok, FaFacebook } from 'react-icons/fa'

// Local imports
import { Loader, CustomNextArrow, CustomPrevArrow } from '../components'

const CarDetails = () => {
	const { id } = useParams()
	const [carDetails, setCarDetails] = useState([])
	const [carImages, setCarImages] = useState([])
	const [dealerInfo, setDealerInfo] = useState({})
	const [loading, setLoading] = useState(true)
	const [error, setError] = useState(null)

	const BASE_IMAGE_URL = 'https://www.carmodoo.com'

	useEffect(() => {
		const fetchCarDetails = async () => {
			setLoading(true)
			try {
				// –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö
				const response = await axios.get(
					`https://corsproxy.io/?https://www.carmodoo.com/app/market/car_detail_tab.html?m_no=${id}&tab=1`,
					{ responseType: 'text' },
				)

				// –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π div –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML
				const tempDiv = document.createElement('div')
				tempDiv.innerHTML = response.data

				// üîπ –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–æ—Ç–æ üîπ
				const imageElements = tempDiv.querySelectorAll('.car-album li')
				const images = Array.from(imageElements)
					.map(
						(li) =>
							li.style.backgroundImage.match(/url\(["']?(.*?)["']?\)/)?.[1],
					)
					.filter(Boolean)
					.map((src) => (src.startsWith('/data') ? BASE_IMAGE_URL + src : src)) // –§–æ—Ä–º–∏—Ä—É–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ URL

				setCarImages(images)

				const carInfo = []

				// üîπ –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–≥–¥–µ –µ—Å—Ç—å .article-tag –∏ .article-content)
				Array.from(
					tempDiv.querySelectorAll('.article-list.carinfo-list li'),
				).forEach((li) => {
					const label = li.querySelector('.article-tag')?.innerText?.trim()
					const value = li.querySelector('.article-content')?.innerText?.trim()

					if (label && value) {
						carInfo.push({ label, value })
					}
				})

				// üîπ –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ <p> –≤–Ω—É—Ç—Ä–∏ <li>
				Array.from(
					tempDiv.querySelectorAll('.article-list.carinfo-list li p'),
				).forEach((p) => {
					const label = p.querySelector('.article-tag')?.innerText?.trim()
					const value = p.querySelector('.article-content')?.innerText?.trim()

					if (label && value) {
						carInfo.push({ label, value })
					}
				})

				setCarDetails(carInfo)

				console.log(carInfo)

				// üîπ –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥–∞–≤—Ü–µ üîπ
				const dealer = {
					name:
						tempDiv.querySelector('.dealer-info span')?.innerText ||
						'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
					phone:
						tempDiv.querySelector('.dealer-info p')?.innerText || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
					address:
						tempDiv.querySelector('.article-content[style*="padding:8px"]')
							?.innerText || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
				}
				setDealerInfo(dealer)
			} catch (err) {
				console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', err)
				setError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö')
			} finally {
				setLoading(false)
			}
		}

		fetchCarDetails()
	}, [id])

	if (loading) return <Loader />
	if (error) return <p className='text-red-500'>{error}</p>

	// üîπ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª–∞–π–¥–µ—Ä–∞ üîπ
	const sliderSettings = {
		dots: true,
		infinite: true,
		speed: 500,
		slidesToShow: 1,
		slidesToScroll: 1,
		prevArrow: <CustomPrevArrow />,
		nextArrow: <CustomNextArrow />,
	}

	// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–± –∞–≤—Ç–æ–º–æ–±–∏–ª–µ
	const formattedCarPrice = (
		parseInt(carDetails[0].value.replace(/\D+/gm, '')) * 10000
	).toLocaleString()
	const formattedCarDate = `${
		carDetails
			.filter((item) => item.label === 'ÏµúÏ¥àÎì±Î°ùÏùº')[0]
			.value.split('.')[0]
	}/${
		carDetails
			.filter((item) => item.label === 'ÏµúÏ¥àÎì±Î°ùÏùº')[0]
			.value.split('.')[1]
	}`
	const formattedCarMileage = parseInt(
		carDetails
			.filter((item) => item.label === 'Ï£ºÌñâÍ±∞Î¶¨')[0]
			.value.replace(/\D+/gm, ''),
	).toLocaleString()
	const formattedFuelType =
		carDetails[21].value === 'ÌúòÎ∞úÏú†'
			? '–ì–∞–∑'
			: carDetails[21].value === 'Í∞ÄÏÜîÎ¶∞'
			? '–ë–µ–Ω–∑–∏–Ω'
			: '–î–∏–∑–µ–ª—å'
	const formattedTransmissionType =
		carDetails.filter((item) => item.label === 'Î≥ÄÏÜçÍ∏∞')[0].value === 'Ïò§ÌÜ†'
			? '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è'
			: '–ú–µ—Ö–∞–Ω–∏–∫–∞'

	return (
		<div className='container mx-auto mt-16 py-12 px-4'>
			{/* <h2 className='text-3xl font-bold mb-6 text-center'>{}</h2> */}

			{/* üîπ –ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π üîπ */}
			{carImages.length > 0 ? (
				<div className='w-full flex justify-center'>
					<div className='w-full max-w-4xl mb-10'>
						<Slider {...sliderSettings}>
							{carImages.map((img, index) => (
								<div key={index} className='flex justify-center'>
									<img
										src={img}
										alt={`Car ${index}`}
										className='w-full h-auto max-h-[400px] object-contain'
									/>
								</div>
							))}
						</Slider>
					</div>
				</div>
			) : (
				<p className='text-gray-500 text-center mb-6'>–§–æ—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>
			)}

			{/* üîπ –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è üîπ */}
			<div className='bg-white shadow-lg p-6 rounded-lg mb-6'>
				<h3 className='text-2xl font-semibold mb-4'>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
				<ul className='space-y-2 text-lg'>
					<li className='flex justify-between border-b pb-2'>
						{/* –¶–µ–Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è */}
						<span className='font-semibold text-gray-700'>–¶–µ–Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è</span>
						<span className='text-gray-900'>‚Ç©{formattedCarPrice}</span>
					</li>
					<li className='flex justify-between border-b pb-2'>
						{/* –ù–æ–º–µ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª—è */}
						<span className='font-semibold text-gray-700'>
							–ù–æ–º–µ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª—è
						</span>
						<span className='text-gray-900'>{carDetails[1].value}</span>
					</li>
					<li className='flex justify-between border-b pb-2'>
						{/* –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞ */}
						<span className='font-semibold text-gray-700'>–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞</span>
						<span className='text-gray-900'>{formattedCarDate}</span>
					</li>
					<li className='flex justify-between border-b pb-2'>
						{/* –ü—Ä–æ–±–µ–≥ */}
						<span className='font-semibold text-gray-700'>–ü—Ä–æ–±–µ–≥</span>
						<span className='text-gray-900'>{formattedCarMileage} –∫–º</span>
					</li>
					<li className='flex justify-between border-b pb-2'>
						{/* –¢–æ–ø–ª–∏–≤–æ */}
						<span className='font-semibold text-gray-700'>–¢–æ–ø–ª–∏–≤–æ</span>
						<span className='text-gray-900'>{formattedFuelType}</span>
					</li>
					<li className='flex justify-between border-b pb-2'>
						{/* –ö–ü–ü */}
						<span className='font-semibold text-gray-700'>–ö–æ—Ä–æ–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á</span>
						<span className='text-gray-900'>{formattedTransmissionType}</span>
					</li>
				</ul>

				{/* üîπ –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è üîπ */}
				<div className='bg-white shadow-lg p-6 rounded-lg mb-6 mt-5 text-center'>
					<h3 className='text-2xl font-semibold mb-4 text-center'>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h3>
					<div className='text-lg text-center space-y-2'>
						<p>
							üìû <strong>–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω:</strong> +82 10-7650-3034
						</p>
						<p>
							üìû <strong>–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω:</strong> +82 10-7291-1701
						</p>
						<p>
							üìû <strong>–ï–ª–µ–Ω–∞ (English, ÌïúÍµ≠Ïñ¥):</strong> +82 10-3504-1522
						</p>
					</div>

					<div className='mt-10'>
						<h3 className='text-xl font-bold'>KPP Motors –≤ —Å–æ—Ü. —Å–µ—Ç—è—Ö</h3>
						<a
							href='https://www.instagram.com/kpp_motors'
							target='_blank'
							rel='noopener noreferrer'
							className='flex items-center justify-center mt-3 mb-3'
						>
							<FaInstagram
								size={30}
								className='text-pink-500 hover:text-pink-600 transition mr-1'
							/>{' '}
							Instagram
						</a>
						<a
							href='https://www.facebook.com/share/1D8bg2xL1i/?mibextid=wwXIfr'
							target='_blank'
							rel='noopener noreferrer'
							className='flex items-center justify-center mt-3 mb-3'
						>
							<FaFacebook
								size={30}
								className='text-blue-600 hover:text-blue-700 transition mr-1'
							/>
							Facebook
						</a>
						<a
							href='https://www.tiktok.com/@kpp_motors'
							target='_blank'
							rel='noopener noreferrer'
							className='flex items-center justify-center mt-3 mb-3'
						>
							<FaTiktok
								size={30}
								className='text-black hover:text-gray-700 transition mr-1'
							/>{' '}
							TikTok
						</a>
					</div>
				</div>

				{/* üîπ –ö–Ω–æ–ø–∫–∞ —Å–≤—è–∑–∏ üîπ */}
				<div className='mt-6 flex justify-center'>
					<a
						href='https://wa.me/821076503034'
						target='_blank'
						rel='noopener noreferrer'
						className='bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg flex items-center gap-2 shadow-md transition-all'
					>
						<FaWhatsapp size={24} />
						<span>–°–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º</span>
					</a>
				</div>
			</div>
		</div>
	)
}

export default CarDetails
